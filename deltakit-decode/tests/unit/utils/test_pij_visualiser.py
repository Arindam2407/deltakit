# (c) Copyright Riverlane 2020-2025.
import platform
from unittest import mock

import pytest
from deltakit_decode.utils._pij_visualiser import plot_correlation_matrix


class TestPijVisualiser:
    @pytest.mark.parametrize(
        "matrix, major_minor_mapping",
        [
            [
                [[0.08155714285714295, -0.010713351064907894, 0.0, -0.010713351064907894, 0.0, 0.0, 0.0, 0.0], [-0.010713351064907894, 0.9895113853568062, 0.0, 0.1111111111111111, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.1111111111111111, 0.0],
                 [-0.010713351064907894, 0.1111111111111111, 0.0, 0.9895113853568062, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.1111111111111111, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]],
                {(1.0, 4.0): [0, 4], (3.0, 4.0): [1, 5],
                 (3.0, 6.0): [2, 6], (5.0, 6.0): [3, 7]},
            ],
            [
                [[0.1174505966134559, 5.837840850303477e-05, 0.0, 0.0, 0.0, 0.0, 0.0033969500102377093, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0021703933982749612, 0.0, 0.0, 0.0, 0.0, 0.029459473033565553, 0.005653928489673998, 0.0, 0.0, 0.0, 0.0], [5.837840850303477e-05, 0.04551550723348229, 0.0015633121920086701, 0.0, 0.0, 0.0, 0.0002694083680992998, 0.03790345231176562, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0023681689647790383, 0.0, 0.0, 0.0, 0.0, 0.03391940293960499, 0.001051769393903057, 0.0, 0.0, 0.0], [0.0, 0.0015633121920086701, 0.08651894856083293, 0.0012918472336771458, 0.0, 0.0, 0.0, 0.030405150326564157, 0.0044617889726719095, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.002172693153775329, 0.0, 0.0, 0.0, 0.0, 0.027984373755002068, 0.007929363945550938, 0.0, 0.0], [0.0, 0.0, 0.0012918472336771458, 0.045744965556093246, 0.002805042152225601, 0.0, 0.0, 0.0, 6.645559185447514e-06, 0.03852901555238519, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.001967333588214215, 0.0, 0.0, 0.0, 0.0, 0.032676486586826314, 0.0006605574154216476, 0.0], [0.0, 0.0, 0.0, 0.002805042152225601, 0.08430965094219844, 0.0021191286955135613, 0.0, 0.0, 0.0, 0.029471609130065857, 0.0034586936869899776, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.002235768312187414, 0.0, 0.0, 0.0, 0.0, 0.02849572252441407, 0.008068947959818884], [0.0, 0.0, 0.0, 0.0, 0.0021191286955135613, 0.04800572942775009, 0.0, 0.0, 0.0, 0.0, 0.00016621900521496258, 0.03732508255785305, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.03377131332412736], [0.0033969500102377093, 0.0002694083680992998, 0.0, 0.0, 0.0, 0.0, 0.07739937962679226, 0.006304565824739483, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0029128413532241715, 0.0, 0.0, 0.0, 0.0], [0.0, 0.03790345231176562, 0.030405150326564157, 0.0, 0.0, 0.0, 0.006304565824739483, 0.07559024781243702, 0.002868529500751227, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0017414746364182165, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0044617889726719095, 6.645559185447514e-06, 0.0, 0.0, 0.0, 0.002868529500751227, 0.073647168255709, 0.006808681993422827, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.004175763292184775, 0.0, 0.0], [0.0, 0.0, 0.0, 0.03852901555238519, 0.029471609130065857, 0.0, 0.0, 0.0, 0.006808681993422827, 0.07849661480645605, 0.002332912100089124, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0011708642415981796, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0034586936869899776, 0.00016621900521496258, 0.0, 0.0, 0.0, 0.002332912100089124, 0.0743670462989586, 0.006330654381463907, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.00435744864841936], [0.0, 0.0, 0.0, 0.0, 0.0, 0.03732508255785305, 0.0, 0.0, 0.0, 0.0, 0.006330654381463907, 0.10905870200243195, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                 [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.10392065331006212, 0.008650733655094611, 0.0, 0.0, 0.0, 0.0, 0.032492004339083114, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0021703933982749612, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.008650733655094611, 0.0952234148782009, 0.001876040683835789, 0.0, 0.0, 0.0, 3.130775328430424e-07, 0.0025136844937678204, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0023681689647790383, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.001876040683835789, 0.07287127904108855, 0.008048770793723514, 0.0, 0.0, 0.0, 0.02996865757262679, 0.031957510864608796, 0.0, 0.0, 0.0], [0.0, 0.0, 0.002172693153775329, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.008048770793723514, 0.09386030132845684, 0.00212595310063618, 0.0, 0.0, 0.0, 0.0010592278973130531, 0.003335912259372853, 0.0, 0.0], [0.0, 0.0, 0.0, 0.001967333588214215, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.00212595310063618, 0.07574656757873897, 0.007292298572883826, 0.0, 0.0, 0.0, 0.0266316292986451, 0.03166821612240017, 0.0], [0.0, 0.0, 0.0, 0.0, 0.002235768312187414, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.007292298572883826, 0.0977406913084846, 0.0, 0.0, 0.0, 0.0, 0.00026461800103988464, 0.003070810256326939], [0.029459473033565553, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.032492004339083114, 3.130775328430424e-07, 0.0, 0.0, 0.0, 0.0, 0.05251452846159589, 0.0001230841508201852, 0.0, 0.0, 0.0, 0.0], [0.005653928489673998, 0.03391940293960499, 0.0, 0.0, 0.0, 0.0, 0.0029128413532241715, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0025136844937678204, 0.02996865757262679, 0.0, 0.0, 0.0, 0.0001230841508201852, 0.08997803071302188, 0.0008974611451682546, 0.0, 0.0, 0.0], [0.0, 0.001051769393903057, 0.027984373755002068, 0.0, 0.0, 0.0, 0.0, 0.0017414746364182165, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.031957510864608796, 0.0010592278973130531, 0.0, 0.0, 0.0, 0.0008974611451682546, 0.049722477154960955, 0.0009482626326038912, 0.0, 0.0], [0.0, 0.0, 0.007929363945550938, 0.032676486586826314, 0.0, 0.0, 0.0, 0.0, 0.004175763292184775, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.003335912259372853, 0.0266316292986451, 0.0, 0.0, 0.0, 0.0009482626326038912, 0.08694066417869489, 0.0020530644693578237, 0.0], [0.0, 0.0, 0.0, 0.0006605574154216476, 0.02849572252441407, 0.0, 0.0, 0.0, 0.0, 0.0011708642415981796, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.03166821612240017, 0.00026461800103988464, 0.0, 0.0, 0.0, 0.0020530644693578237, 0.0475047568480284, 0.0012011471472747615], [0.0, 0.0, 0.0, 0.0, 0.008068947959818884, 0.03377131332412736, 0.0, 0.0, 0.0, 0.0, 0.00435744864841936, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.003070810256326939, 0.0, 0.0, 0.0, 0.0, 0.0012011471472747615, 0.11106620112455949]],
                {(4.0, 7.0): [0, 4, 8, 12, 16, 20], (4.0, 9.0): [1, 5, 9, 13, 17, 21],
                 (6.0, 5.0): [2, 6, 10, 14, 18, 22], (6.0, 7.0): [3, 7, 11, 15, 19, 23]},
            ],
            [
                [[0.07825142857142861, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.0025010484184897486, 0.0, 0.0, 0.0, -0.0025010484184897486, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.02702702702702703, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.02702702702702703, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                 [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [-0.0025010484184897486, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.9975113998006957, 0.0, 0.0, 0.0, 0.027027027027026973, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [-0.0025010484184897486, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.027027027027026973, 0.0, 0.0, 0.0, 0.9975113998006957, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]],
                {(1.0, 0.0): [0, 6, 12, 18], (1.0, 2.0): [1, 7, 13, 19], (1.0, 4.0): [2, 8, 14, 20],
                 (3.0, 0.0): [3, 9, 15, 21], (3.0, 2.0): [4, 10, 16, 22], (3.0, 4.0): [5, 11, 17, 23]},
            ]
        ]
    )
    @pytest.mark.skipif("wsl" in platform.uname().release.lower(),
                        reason="Saving figures in WSL doesn't work because the "
                               "default TKinter backend needs a display")
    def test_plot_correlation_matrix_creates_figure(self, tmp_path, matrix, major_minor_mapping):
        filepath = tmp_path / "testfig.png"
        plt = plot_correlation_matrix(matrix, major_minor_mapping)
        plt.savefig(filepath)
        plt.clf()
        assert filepath.is_file()

    def test_plot_correlation_matrix_raises_exception_if_seaborn_not_installed(self):
        with mock.patch("builtins.__import__", side_effect=ImportError):
            with pytest.raises(ImportError, match=r"Seaborn is not installed - please install Visualisation extras"):
                plot_correlation_matrix([], {})
